<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #result {
            display: none; /* 初始隐藏结果 */
        }
    </style>
    <script src="https://static.qiantucdn.com/assets/components/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/tesseract.js/4.0.0/tesseract.min.js"></script>
</head>

<body>
    <div class="container">
        <input type="text" id="inputUrl" placeholder="输入视频链接">
        <button onclick="parseCaptcha()">解析</button>
        <div id="result">
            <h2 id="title"></h2>
            <img id="cover" src="" alt="封面" style="max-width: 100%; height: auto;">
            <video id="video" src="" controls style="max-width: 100%; height: auto;"></video>
            <p id="coverUrl"></p>
            <p id="videoUrl"></p>
        </div>
    </div>

<script>
async function parseCaptcha() {
    try {
        const response = await fetch('https://ver.kukutool.com/captcha');
        const obj = await response.json();
        await ocrcaptcha(obj);
    } catch (error) {
        console.error('请求失败:', error);
        alert('请求失败: ' + error.message);
    }
}

async function ocrcaptcha(obj) {
    const svgString = obj.image;

    // 创建一个 canvas 元素
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // 创建一个 Image 对象
    const img = new Image();

    // 将 SVG 字符串转换为 Blob 对象
    const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
    const svgUrl = URL.createObjectURL(svgBlob);

    // 设置 Image 对象的 src 属性为 SVG 的 URL
    img.onload = async function() {
        console.log('图片加载成功');
        // 将图片绘制到 canvas 上
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // 图像预处理：调整图像大小、灰度化、二值化
        const processedCanvas = document.createElement('canvas');
        const processedCtx = processedCanvas.getContext('2d');
        processedCanvas.width = canvas.width;
        processedCanvas.height = canvas.height;
        processedCtx.drawImage(canvas, 0, 0);

        // 灰度化
        const imageData = processedCtx.getImageData(0, 0, processedCanvas.width, processedCanvas.height);
        for (let i = 0; i < imageData.data.length; i += 4) {
            const avg = (imageData.data[i] + imageData.data[i + 1] + imageData.data[i + 2]) / 3;
            imageData.data[i] = avg; // red
            imageData.data[i + 1] = avg; // green
            imageData.data[i + 2] = avg; // blue
            imageData.data[i + 3] = 255; // alpha
        }
        processedCtx.putImageData(imageData, 0, 0);

        // 将 canvas 转换为 Base64 编码的图片字符串
        const dataUrl = processedCanvas.toDataURL("image/png");
        console.log('Base64 编码的图片字符串生成成功:', dataUrl);

        // 之后就可以使用 Tesseract.js 对 dataUrl 进行识别了
        await recognizeText(dataUrl, obj);
    }

    img.src = svgUrl;
}

async function recognizeText(imageDataUrl, obj) {
    const { createWorker } = Tesseract;
    const worker = await createWorker({
        logger: m => console.log(m)
    });

    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');

    const { data: { text } } = await worker.recognize(imageDataUrl, {
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'
    });

    console.log('识别结果:', text); // 输出识别结果

    // 去除换行符和空白字符
    const cleanedText = text.replace(/\s+/g, '');

    // 调用 parse 函数
    await parse($('#inputUrl').val(), obj.key, cleanedText);

    await worker.terminate();
}

async function parse(url, key, text) {
    try {
        const response = await fetch('https://dy.kukutool.com/api/parse', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Origin': 'https://dy.kukutool.com',
                'X-Requested-With': 'mark.via',
                'Accept': '*/*',
                'Accept-Encoding': 'gzip, deflate, br, zstd',
                'Accept-Language': 'zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7',
                'Cookie': 'NEXT_LOCALE=zh'
            },
            body: JSON.stringify({
                requestURL: url,
                captchaKey: key,
                captchaInput: text
            })
        });

        const obj1 = await response.json();
        console.log('解析结果:', obj1);
        const status = obj1.status;

        if (status === 0) {
            const cover = obj1.data.cover;
            const title = obj1.data.title;
            const videoUrl = obj1.data.url;

            // 显示结果
            $('#title').text(title);
            $('#cover').attr('src', cover);
            $('#video').attr('src', videoUrl);
            $('#coverUrl').text('封面链接: ' + cover);
            $('#videoUrl').text('视频链接: ' + videoUrl);

            // 显示结果区域
            $('#result').show();
        } else {
            console.error('解析失败:', obj1.message);
            alert('解析失败: ' + obj1.message);
        }
    } catch (error) {
        console.error('请求失败:', error);
        alert('请求失败: ' + error.message);
    }
}
</script>
</body>
</html>
